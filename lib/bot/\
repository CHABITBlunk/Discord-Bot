import random
from discord import File
from discord import Embed
from discord.ext.commands import Bot as BotBase
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from discord.ext.commands import CommandNotFound

PREFIX = '.'
OWNER_IDS = [4660158167480576]

class Bot(BotBase):
    def __init__(self):
        self.ready = False
        self.guild = None
        self.scheduler = AsyncIOScheduler()
        self.PREFIX = PREFIX
        super().__init__(
                command_prefix=PREFIX, 
                owner_ids=OWNER_IDS
        )
    
    def run(self, version):
        self.VERSION = version
        with open('./lib/bot/token.0', 
                'r', 
                encoding='utf-8') as tf:
            self.TOKEN = tf.read()
        print('running bot...')
        super().run(self.TOKEN, reconnect=True)

    async def on_connect(self):
        print('bot connected')
    
    async def on_disconnect(self):
        print('bot disconnected')

    async def on_error(self, err, *args, **kwargs):
        if err == 'on_command_error':
            await args[0].send('Something went wrong')
        raise 

    async def on_command_error(self, ctx, exc):
        if isinstance(exc, CommandNotFound):
            pass
        elif hasattr(exc, 'original'):
            raise exc.original
        else:
            raise exc

    async def on_ready(self):
        if not self.ready:
            self.ready = True
            self.guild = self.get_guild(856408164793450506)
            print('bot ready')
        else:
            print('bot reconnected')
        channel = self.get_channel(864003308225429504)
        await channel.send("hey fucker i'm online")

        embed = Embed(title='Online', description='Ball Inspector is online', colour=0x4b0082)
        fields = [('Name', 'Value', True),
                  ('Another field', 'this field is next to the other one', True),
                  ('A non-inline field', 'this field is on its own row', False)]
        for name, value, inline in fields:
            embed.add_field(name=name, value=value, inline=inline)
        embed.set_footer(text='we got ourselves a footer')
        embed.set_author(name='Ball Inspector', icon_url=self.guild.icon_url)
        embed.set_thumbnail(url=self.guild.icon_url)
        embed.set_image(url=self.guild.icon_url)
        await channel.send(embed=embed)
        rand = random.randint(1, 7)
        await channel.send(file=File('./gifs/inspection-{0}.gif'.format(rand)))

    async def on_message(self, message):
        pass

bot = Bot()
